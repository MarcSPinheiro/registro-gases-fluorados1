<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Registo de Gases Fluorados</title>
    <!-- Tesseract.js para OCR -->
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .nav-tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-section {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .form-section {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h2 {
            font-size: 1.4rem;
            margin: 20px 0 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
            color: #2c3e50;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            margin: 5px;
            font-size: 1rem;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        /* ESTILOS OCR - GARANTIR VISIBILIDADE */
        .ocr-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
        }
        
        .ocr-buttons {
            margin: 20px 0;
        }
        
        .camera-view {
            display: none;
            margin: 20px 0;
            text-align: center;
        }
        
        #cameraVideo {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            background: #000;
        }
        
        .ocr-preview {
            max-width: 100%;
            max-height: 300px;
            margin: 15px 0;
            border-radius: 4px;
            display: none;
        }
        
        .ocr-results {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 20px;
            margin-top: 15px;
            text-align: left;
            display: none;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Dashboard - Registo de Gases Fluorados</h1>
            <p>Decreto-Lei n.¬∫ 145/2017, de 30 de novembro</p>
        </header>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="openTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="openTab('registos')">Registos</button>
            <button class="nav-tab" onclick="openTab('novoRegisto')" style="margin-left: auto;">Novo Registo</button>
        </div>
        
        <!-- Tab: Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-section">
                <h2>Estat√≠sticas Gerais</h2>
                <p>Conte√∫do do dashboard...</p>
            </div>
        </div>
        
        <!-- Tab: Registos -->
        <div id="registos" class="tab-content">
            <div class="dashboard-section">
                <h2>Lista de Registos</h2>
                <p>Conte√∫do dos registos...</p>
            </div>
        </div>
        
        <!-- Tab: Novo Registo -->
        <div id="novoRegisto" class="tab-content">
            <div class="dashboard-section">
                <h2>Novo Registo de Interven√ß√£o</h2>
                
                <!-- SE√á√ÉO OCR - GARANTIDA PARA APARECER -->
                <div class="form-section">
                    <h2 style="color: #27ae60;">üì∏ SCAN AUTOM√ÅTICO DA ETIQUETA</h2>
                    <div class="ocr-container">
                        <p style="font-size: 1.1rem; margin-bottom: 20px; font-weight: bold;">
                            Capture uma foto da etiqueta para preenchimento autom√°tico
                        </p>
                        
                        <!-- Container da C√¢mara -->
                        <div class="camera-view" id="cameraContainer">
                            <video id="cameraVideo" autoplay playsinline></video>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-success" onclick="captureImage()">
                                    üì∑ Capturar Foto
                                </button>
                                <button class="btn btn-danger" onclick="stopCamera()">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </div>
                        
                        <!-- BOT√ïES PRINCIPAIS - SEMPRE VIS√çVEIS -->
                        <div class="ocr-buttons" id="cameraButtons">
                            <button class="btn btn-success" onclick="startCamera()">
                                üì∑ Usar C√¢mara
                            </button>
                            <div class="file-input-wrapper">
                                <button class="btn btn-primary">
                                    üìÅ Carregar Foto
                                </button>
                                <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)">
                            </div>
                        </div>
                        
                        <!-- Pr√©-visualiza√ß√£o -->
                        <img id="ocrPreview" class="ocr-preview" alt="Pr√©-visualiza√ß√£o">
                        
                        <!-- Resultados -->
                        <div id="ocrResults" class="ocr-results">
                            <h4>üìã Dados Extra√≠dos da Etiqueta:</h4>
                            <div id="extractedData"></div>
                            <button class="btn btn-success" onclick="applyExtractedData()" style="margin-top: 15px;">
                                ‚úÖ Aplicar Dados ao Formul√°rio
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Formul√°rio normal -->
                <div class="form-section">
                    <h2>Dados do Equipamento</h2>
                    <p>Formul√°rio normal aqui...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== VARI√ÅVEIS GLOBAIS =====
        let currentStream = null;
        let extractedData = {};

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('P√°gina carregada - Se√ß√£o OCR deve estar vis√≠vel');
            // Garantir que os bot√µes est√£o vis√≠veis
            document.getElementById('cameraButtons').style.display = 'block';
        });

        // ===== FUN√á√ïES DE TABS =====
        function openTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar a tab selecionada
            document.getElementById(tabName).classList.add('active');
            
            // Ativar o bot√£o correspondente
            event.currentTarget.classList.add('active');
        }

        // ===== FUN√á√ïES OCR =====
        async function startCamera() {
            try {
                console.log('Iniciando c√¢mara...');
                
                // Parar c√¢mara anterior se existir
                if (currentStream) {
                    stopCamera();
                }
                
                const video = document.getElementById('cameraVideo');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                currentStream = stream;
                video.srcObject = stream;
                
                // Mostrar c√¢mara e ocultar bot√µes
                document.getElementById('cameraContainer').style.display = 'block';
                document.getElementById('cameraButtons').style.display = 'none';
                
                alert('C√¢mara ativada! Aponte para a etiqueta e clique em Capturar Foto.');
                
            } catch (error) {
                console.error('Erro ao aceder √† c√¢mara:', error);
                alert('Erro ao aceder √† c√¢mara: ' + error.message);
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // Ocultar c√¢mara e mostrar bot√µes
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('cameraButtons').style.display = 'block';
            
            // Limpar o elemento de v√≠deo
            const video = document.getElementById('cameraVideo');
            video.srcObject = null;
        }

        function captureImage() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(function(blob) {
                processImage(blob);
            }, 'image/jpeg', 0.8);
            
            stopCamera();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processImage(file);
            }
            // Reset do input para permitir reutiliza√ß√£o
            event.target.value = '';
        }

        async function processImage(imageBlob) {
            const preview = document.getElementById('ocrPreview');
            const results = document.getElementById('ocrResults');
            
            // Mostrar pr√©-visualiza√ß√£o
            preview.src = URL.createObjectURL(imageBlob);
            preview.style.display = 'block';
            
            // Mostrar mensagem de processamento
            results.innerHTML = '<p>üîÑ A processar imagem...</p>';
            results.style.display = 'block';
            
            try {
                // Usar Tesseract.js para OCR
                const { data: { text } } = await Tesseract.recognize(
                    imageBlob,
                    'por+eng',
                    { 
                        logger: m => console.log(m) 
                    }
                );
                
                console.log('Texto extra√≠do:', text);
                extractEquipmentData(text);
                
            } catch (error) {
                console.error('Erro no OCR:', error);
                results.innerHTML = '<p style="color: red;">Erro ao processar a imagem. Tente novamente.</p>';
            }
        }

        function extractEquipmentData(text) {
            extractedData = {};
            
            // Procurar marca
            const marcas = ['GREE', 'DAIKIN', 'MITSUBISHI', 'LG', 'SAMSUNG', 'FUJITSU', 'PANASONIC', 'CARRIER', 'TRANE'];
            for (const marca of marcas) {
                if (text.toUpperCase().includes(marca)) {
                    extractedData.marca = marca;
                    break;
                }
            }
            
            // Procurar modelo
            const modelMatch = text.match(/Model[o]?[\s:]*([^\n]+)/i);
            if (modelMatch) {
                extractedData.modelo = modelMatch[1].trim();
            }
            
            // Procurar n√∫mero de s√©rie
            const serialMatch = text.match(/Serial No\.?[\s:]*([^\n]+)/i);
            if (serialMatch) {
                extractedData.numeroSerie = serialMatch[1].trim();
            }
            
            // Procurar pot√™ncias
            const coolingMatch = text.match(/Cooling Capacity[\s:]*([\d.,]+)\s*kW/i);
            if (coolingMatch) {
                extractedData.potenciaFrio = parseFloat(coolingMatch[1].replace(',', '.'));
            }
            
            const heatingMatch = text.match(/Heating Capacity[\s:]*([\d.,]+)\s*kW/i);
            if (heatingMatch) {
                extractedData.potenciaCalor = parseFloat(heatingMatch[1].replace(',', '.'));
            }
            
            displayExtractedData();
        }

        function displayExtractedData() {
            const resultsDiv = document.getElementById('extractedData');
            let html = '<div style="font-size: 0.95rem; line-height: 1.5;">';
            
            if (extractedData.marca) {
                html += `<p><strong>Marca:</strong> ${extractedData.marca}</p>`;
            }
            
            if (extractedData.modelo) {
                html += `<p><strong>Modelo:</strong> ${extractedData.modelo}</p>`;
            }
            
            if (extractedData.numeroSerie) {
                html += `<p><strong>N¬∫ S√©rie:</strong> ${extractedData.numeroSerie}</p>`;
            }
            
            if (extractedData.potenciaFrio) {
                html += `<p><strong>Pot√™ncia Frio:</strong> ${extractedData.potenciaFrio} kW</p>`;
            }
            
            if (extractedData.potenciaCalor) {
                html += `<p><strong>Pot√™ncia Calor:</strong> ${extractedData.potenciaCalor} kW</p>`;
            }
            
            if (Object.keys(extractedData).length === 0) {
                html += '<p style="color: #e74c3c;">N√£o foi poss√≠vel extrair dados. Tente uma foto mais n√≠tida.</p>';
            } else {
                html += '<p style="color: #27ae60; margin-top: 10px;">‚úÖ Dados extra√≠dos com sucesso!</p>';
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function applyExtractedData() {
            let appliedCount = 0;

            // Simular aplica√ß√£o dos dados
            if (extractedData.marca) {
                console.log('Aplicando marca:', extractedData.marca);
                appliedCount++;
            }
            
            if (extractedData.modelo) {
                console.log('Aplicando modelo:', extractedData.modelo);
                appliedCount++;
            }
            
            if (extractedData.numeroSerie) {
                console.log('Aplicando n√∫mero de s√©rie:', extractedData.numeroSerie);
                appliedCount++;
            }
            
            alert(`${appliedCount} campos ser√£o preenchidos automaticamente!`);
            document.getElementById('ocrResults').style.display = 'none';
        }

        // For√ßar abertura da tab novoRegisto para teste
        setTimeout(() => {
            openTab('novoRegisto');
            console.log('Abrindo tab novoRegisto automaticamente para teste');
        }, 1000);
    </script>
</body>
</html>
